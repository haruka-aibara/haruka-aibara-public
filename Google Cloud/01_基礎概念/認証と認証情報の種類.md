# Google Cloud の認証と認証情報の種類

Google Cloud でアプリケーションやサービスを利用する際に必要な認証の概念と、主要な認証情報の種類について説明します。

## 概要

Google Cloud では、リソースにアクセスするために認証（Authentication）と認可（Authorization）が必要です。認証は「誰がアクセスしているか」を確認し、認可は「何を実行できるか」を制御します。

## 認証情報（Credentials）の種類

Google Cloud では、主に以下の3種類の認証情報を使用できます：

### 1. ユーザー認証情報（User Credentials）

**ユーザー認証情報**は、Google アカウント（個人アカウントやGoogle Workspaceアカウント）を使用した認証方式です。

#### 特徴

- **対象**: 開発者や管理者など、人間のユーザー
- **取得方法**: `gcloud auth login` コマンドやブラウザでのログイン
- **保存場所**: `~/.config/gcloud/` ディレクトリ内に保存
- **用途**: 開発環境やローカル環境での操作、手動での管理作業

#### 設定方法

```bash
# ユーザーアカウントでログイン
gcloud auth login

# 認証状態の確認
gcloud auth list

# アクティブなアカウントの確認
gcloud config get-value account
```

#### 認証情報の確認

```bash
# 現在のユーザー認証情報の確認
gcloud auth application-default print-access-token
```

### 2. サービスアカウント認証情報（Service Account Credentials）

**サービスアカウント認証情報**は、アプリケーションやサービスが Google Cloud のリソースにアクセスするために使用する認証方式です。

#### 特徴

- **対象**: アプリケーション、コンテナ、サーバーレス関数など
- **取得方法**: サービスアカウントキー（JSONファイル）を生成
- **保存形式**: JSONファイル（機密情報を含む）
- **用途**: 本番環境、CI/CDパイプライン、自動化されたタスク

#### サービスアカウントの作成

```bash
# サービスアカウントの作成
gcloud iam service-accounts create SERVICE_ACCOUNT_NAME \
  --display-name="Display Name" \
  --project=PROJECT_ID
```

#### キーの生成

```bash
# サービスアカウントキー（JSON）の生成
gcloud iam service-accounts keys create key.json \
  --iam-account=SERVICE_ACCOUNT_EMAIL \
  --project=PROJECT_ID
```

生成されるJSONファイルの構造：

```json
{
  "type": "service_account",
  "project_id": "your-project-id",
  "private_key_id": "...",
  "private_key": "-----BEGIN PRIVATE KEY-----\n...\n-----END PRIVATE KEY-----\n",
  "client_email": "service-account@project-id.iam.gserviceaccount.com",
  "client_id": "...",
  "auth_uri": "https://accounts.google.com/o/oauth2/auth",
  "token_uri": "https://oauth2.googleapis.com/token",
  "auth_provider_x509_cert_url": "https://www.googleapis.com/oauth2/v1/certs",
  "client_x509_cert_url": "..."
}
```

#### サービスアカウントキーの使用

```bash
# 環境変数で指定
export GOOGLE_APPLICATION_CREDENTIALS="/path/to/key.json"

# または、gcloudコマンドでアクティベート
gcloud auth activate-service-account --key-file=/path/to/key.json
```

### 3. Application Default Credentials (ADC)

**Application Default Credentials (ADC)** は、アプリケーションが認証情報を自動的に検出するためのメカニズムです。明示的に認証情報を指定しなくても、アプリケーションが適切な認証情報を見つけて使用します。

#### ADC の検出順序

ADC は以下の順序で認証情報を検索します：

1. **環境変数 `GOOGLE_APPLICATION_CREDENTIALS`**
   - サービスアカウントキーのJSONファイルのパスを指定
   ```bash
   export GOOGLE_APPLICATION_CREDENTIALS="/path/to/service-account-key.json"
   ```

2. **ユーザー認証情報**
   - `gcloud auth application-default login` で設定したユーザー認証情報
   ```bash
   gcloud auth application-default login
   ```
   - この認証情報は `~/.config/gcloud/application_default_credentials.json` に保存される

3. **GCP 環境内で実行中の場合**
   - Google Cloud 上で実行されている場合（Compute Engine、Cloud Run、GKEなど）、メタデータサーバーから自動的に認証情報を取得
   - 追加の設定は不要

4. **Google Cloud SDK の認証情報**
   - `gcloud auth login` で設定した認証情報

#### ADC の設定（開発環境）

開発環境で ADC を使用する場合：

```bash
# ユーザー認証情報を ADC として設定
gcloud auth application-default login

# 設定の確認
gcloud auth application-default print-access-token
```

#### ADC の利点

- **シンプル**: 認証情報を明示的に管理する必要がない
- **移植性**: コード変更なしで、異なる環境（ローカル、GCP）で動作
- **セキュリティ**: 本番環境では自動的にサービスアカウントを使用

## 認証情報の比較表

| 項目 | ユーザー認証情報 | サービスアカウント | ADC |
|------|-----------------|-------------------|-----|
| **対象** | 人間のユーザー | アプリケーション | アプリケーション |
| **取得方法** | `gcloud auth login` | キー生成 | 自動検出 |
| **保存場所** | `~/.config/gcloud/` | JSONファイル | 自動検出 |
| **用途** | 開発・手動作業 | 本番・自動化 | すべての環境 |
| **セキュリティ** | 中 | 高（最小権限） | 環境に依存 |

## 実践的な使い分け

### 開発環境

```bash
# ユーザー認証情報を使用
gcloud auth login
# または ADC として設定
gcloud auth application-default login
```

### 本番環境・CI/CD

```bash
# サービスアカウントキーを使用
export GOOGLE_APPLICATION_CREDENTIALS="/path/to/service-account-key.json"
```

### Google Cloud 上で実行

```bash
# 追加の設定は不要（ADC が自動的に検出）
# サービスアカウントが Compute Engine などのインスタンスにアタッチされている場合、自動的に使用される
```

## 認証情報の管理ベストプラクティス

### 1. 最小権限の原則

サービスアカウントには、必要な最小限の権限のみを付与：

```bash
# 例: Cloud Storage の読み取り専用権限のみ
gcloud projects add-iam-policy-binding PROJECT_ID \
  --member="serviceAccount:SERVICE_ACCOUNT_EMAIL" \
  --role="roles/storage.objectViewer"
```

### 2. キーファイルの保護

```bash
# ファイル権限の設定（Linux/macOS）
chmod 600 service-account-key.json

# Git にコミットしない
echo "*.json" >> .gitignore
```

### 3. キーのローテーション

定期的にサービスアカウントキーをローテーション：

```bash
# 古いキーの一覧表示
gcloud iam service-accounts keys list \
  --iam-account=SERVICE_ACCOUNT_EMAIL

# 古いキーの削除
gcloud iam service-accounts keys delete KEY_ID \
  --iam-account=SERVICE_ACCOUNT_EMAIL

# 新しいキーの生成
gcloud iam service-accounts keys create new-key.json \
  --iam-account=SERVICE_ACCOUNT_EMAIL
```

### 4. Workload Identity（推奨）

GKE や Cloud Run などでは、Workload Identity を使用してサービスアカウントを安全に使用できます：

- サービスアカウントキーファイルを保存する必要がない
- Kubernetes Secret などでキーを管理する必要がない
- 自動的にサービスアカウントに紐付けられる

## トラブルシューティング

### 認証エラーの確認

```bash
# 現在の認証状態を確認
gcloud auth list

# ADC の認証情報を確認
gcloud auth application-default print-access-token

# 認証情報のクリア
gcloud auth revoke
```

### 認証情報の切り替え

```bash
# ユーザー認証情報に切り替え
gcloud config set account USER_EMAIL

# サービスアカウントに切り替え
gcloud auth activate-service-account --key-file=key.json
```

### 環境変数の確認

```bash
# 設定されている環境変数を確認
echo $GOOGLE_APPLICATION_CREDENTIALS
env | grep GOOGLE
```

## 参考リソース

- [Google Cloud 認証の概要](https://cloud.google.com/docs/authentication)
- [サービスアカウントのドキュメント](https://cloud.google.com/iam/docs/service-accounts)
- [Application Default Credentials](https://cloud.google.com/docs/authentication/application-default-credentials)
- [認証のベストプラクティス](https://cloud.google.com/docs/authentication/best-practices)

## 関連ドキュメント

- [gcloud CLI セットアップ手順](../00_イントロダクション/gcloud%20CLI%20セットアップ手順.md)
- [HCP Terraform からのデプロイ - シークレット管理](../03_デプロイメント/HCP_Terraformからのデプロイ_シークレット管理.md)
